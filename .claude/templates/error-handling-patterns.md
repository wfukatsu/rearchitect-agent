# 共通エラーハンドリングパターン

スキル実行時のエラーハンドリングの標準パターンを定義します。

## エラーカテゴリ

| カテゴリ | 説明 | 対応方針 |
|---------|------|---------|
| **前提条件エラー** | 必要なファイル/ツールが存在しない | ユーザーに通知し、代替案を提示 |
| **入力エラー** | パラメータ不正、形式エラー | 具体的なエラー内容と正しい形式を提示 |
| **処理エラー** | 実行中の失敗（パース、変換等） | 部分的成功を保存し、エラー箇所を報告 |
| **外部依存エラー** | 外部ツール/サービスの問題 | リトライまたは代替手段を提案 |
| **リソースエラー** | メモリ不足、タイムアウト | スコープを縮小して再試行を提案 |

## 標準エラーハンドリングフロー

```
1. エラー検出
   ↓
2. エラーカテゴリの特定
   ↓
3. 部分的成功の保存（可能な場合）
   ↓
4. ユーザーへの明確な報告
   ↓
5. 復旧オプションの提示
```

## 前提条件エラーの処理

### 必須ファイルが存在しない場合

```markdown
## エラー: 前提条件未充足

以下のファイルが見つかりません:
- `reports/01_analysis/ubiquitous-language.md`

### 対応オプション

1. **先行スキルを実行**: `/analyze-system` を実行してファイルを生成
2. **手動で作成**: 必要な形式でファイルを作成
3. **スキップして続行**: 一部機能が制限されます（警告付きで続行）
```

### 必須ツールがインストールされていない場合

```markdown
## エラー: 外部ツール未検出

`mmdc` (Mermaid CLI) がインストールされていません。

### インストール方法

\`\`\`bash
npm install -g @mermaid-js/mermaid-cli
\`\`\`

### 代替オプション

Mermaid図のレンダリングをスキップし、Markdownのまま出力できます。
```

## 入力エラーの処理

### パラメータ不正

```markdown
## エラー: パラメータ不正

指定されたパス `./invalid/path` は存在しません。

### 確認事項

1. パスが正しいか確認してください
2. 相対パスの場合、カレントディレクトリを確認してください

### 正しい使用例

\`\`\`bash
/analyze-system ./src
/analyze-system /absolute/path/to/source
\`\`\`
```

## 処理エラーの処理

### パースエラー

```markdown
## 警告: 一部のファイルでパースエラー

以下のファイルの処理中にエラーが発生しました:

| ファイル | エラー内容 | 対応 |
|---------|----------|------|
| `design-doc.md` | Mermaid構文エラー (line 45) | スキップして続行 |
| `api-spec.yaml` | YAML形式エラー | スキップして続行 |

### 部分的な結果

正常に処理されたファイルの結果を `reports/` に出力しました。

### 修正方法

1. `/fix-mermaid` でMermaid構文を修正
2. YAML Linterでapi-spec.yamlを検証
```

## 外部依存エラーの処理

### ネットワークエラー

```markdown
## エラー: 外部サービス接続失敗

料金情報の取得に失敗しました（AWS Pricing API）。

### 対応オプション

1. **キャッシュ使用**: 前回取得した料金情報を使用（最終更新: 2024-01-15）
2. **デフォルト値使用**: 組み込みの参考価格を使用（精度低下の可能性）
3. **再試行**: ネットワーク接続を確認後、再実行
```

## リソースエラーの処理

### 大規模コードベース

```markdown
## 警告: 大規模コードベース検出

ファイル数: 15,000+
推定処理時間: 30分以上

### 推奨オプション

1. **サンプリング分析**: 主要ディレクトリのみを分析（推奨）
   \`\`\`bash
   /analyze-system ./src/core --sample
   \`\`\`

2. **段階的分析**: モジュール単位で分析
   \`\`\`bash
   /analyze-system ./src/module-a
   /analyze-system ./src/module-b
   \`\`\`

3. **フル分析**: 時間がかかることを了承の上で実行
```

## エラーログ形式

すべてのエラーは以下の形式で記録します:

```markdown
## エラーログ

| 時刻 | カテゴリ | スキル | メッセージ | 対応状況 |
|-----|---------|-------|----------|---------|
| 10:30:45 | 前提条件 | analyze-system | ファイル未検出 | 代替実行 |
| 10:32:10 | 処理 | build-graph | パースエラー | スキップ |
```

## スキルでの実装例

```markdown
### Step X: [処理名]

[処理内容の説明]

**エラーハンドリング:**
- ファイルが存在しない場合 → [対応A]
- パースエラーの場合 → [対応B]
- 対応言語非対応の場合 → [対応C]
```
