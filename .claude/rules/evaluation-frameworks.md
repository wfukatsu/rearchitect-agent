# 評価フレームワーク定義

MMI評価、DDD評価、ドメイン分類で使用する共通フレームワーク。
参照スキル: evaluate-mmi, mmi-analyzer, ddd-evaluation, integrate-evaluations, ddd-redesign, map-domains, design-microservices

## 1. MMI (Modularity Maturity Index) — 2つのバリアント

本システムではMMIを2つのアプローチで評価できる。

### 1A. 4軸定性評価（`/evaluate-mmi`）

手動の定性評価。マイクロサービス移行準備度を判定する。

| 軸 | 重み | 評価観点 |
|----|------|----------|
| **Cohesion** | 30% | 単一責任原則の遵守度、モジュール内の機能的凝集度 |
| **Coupling** | 30% | 他モジュールへの依存度、インターフェースの明確さ |
| **Independence** | 20% | 独立デプロイ・スケーリング可能性 |
| **Reusability** | 20% | 他ドメインでの再利用可能性 |

**スコア計算:**
```
MMI = (0.3 × Cohesion + 0.3 × Coupling + 0.2 × Independence + 0.2 × Reusability) / 5 × 100
```

各軸は1-5のスケール（5が最高）で評価。

**成熟度レベル:**

| スコア | レベル | 意味 |
|--------|--------|------|
| 80-100 | High | マイクロサービス化準備完了 |
| 60-80 | Medium | 軽微なリファクタリングで移行可能 |
| 40-60 | Low-Medium | 大幅なリファクタリングが必要 |
| 0-40 | Immature | 全面再設計が必要 |

### 1B. Lilienthal 3軸定量評価（`/mmi-analyzer`）

Dr. Carola Lilienthal の手法に基づく自動定量評価。Pythonプロジェクト向け。
Pythonスクリプト（metrics_analyzer, architecture_analyzer, mmi_calculator）で自動計測する。

| カテゴリ | 重み | 主な評価対象 |
|---------|------|------------|
| **Modularity（モジュール性）** | 45% | モジュール分割、インターフェース、プロポーション |
| **Hierarchy（階層性）** | 30% | レイヤー違反、循環依存 |
| **Pattern Consistency（パターン一貫性）** | 25% | パターン適用率、DDD分離 |

**スコア計算:**
```
MMI = Modularity × 0.45 + Hierarchy × 0.30 + Pattern × 0.25
```

各カテゴリは0-10のスケールで評価（閾値テーブルに基づく自動スコアリング）。

**成熟度レベル:**

| スコア | レベル | 意味 |
|--------|--------|------|
| 8-10 | Good | 技術的負債が少ない。保守コスト安定 |
| 4-8 | Warning | 段階的リファクタリングを推奨 |
| 0-4 | Critical | リファクタリング vs 置換の判断が必要 |

**使い分け:**
- **1A**（`/evaluate-mmi`）: 言語非依存、手動定性評価、マイクロサービス移行判断
- **1B**（`/mmi-analyzer`）: Python特化、自動定量評価、技術的負債の数値化
- 両方を実行し、結果を `/integrate-evaluations` で統合することを推奨

## 2. DDD評価フレームワーク

DDD評価は**3カテゴリ・12サブ項目**で構成される。各サブ項目は0-100で採点し、重み付き平均で集約する。

### 2.1 カテゴリ構成と重み

| カテゴリ | 重み | サブ項目数 | 評価観点 |
|---------|------|----------|---------|
| **戦略的設計 (Strategic)** | 30% | 3 | ドメイン境界、用語一貫性、サブドメイン識別 |
| **戦術的設計 (Tactical)** | 45% | 6 | DDDビルディングブロックの適用度と品質 |
| **アーキテクチャ (Architecture)** | 25% | 3 | レイヤー構造、依存方向、ポート/アダプター |

**重み配分の根拠**: 戦術的設計はコード品質に直結し改善項目が最多のため最大重み(45%)。戦略的設計はマクロ構造を決定するため30%。アーキテクチャは戦術・戦略の土台として25%。

### 2.2 スコア計算式

#### 戦略的設計スコア

| サブ項目 | 重み | 評価観点 |
|---------|------|---------|
| ユビキタス言語 (UbiquitousLanguage) | 33% | 用語の一貫性、ドメイン用語のコード反映度 |
| 境界コンテキスト (BoundedContext) | 34% | コンテキスト境界の明確さ、独立性 |
| サブドメイン分類 (SubdomainClassification) | 33% | Core/Supporting/Generic の識別と戦略 |

```
Strategic = UbiquitousLanguage × 0.33 + BoundedContext × 0.34 + SubdomainClassification × 0.33
```

#### 戦術的設計スコア

| サブ項目 | 重み | 評価観点 |
|---------|------|---------|
| 値オブジェクト (ValueObject) | 20% | 不変性、バリデーション、プリミティブ執着の排除 |
| エンティティ (Entity) | 20% | ビジネスメソッド比率、ファクトリ/復元メソッド、不変条件 |
| 集約 (Aggregate) | 20% | 集約ルート、内部保護、トランザクション境界 |
| リポジトリ (Repository) | 15% | インターフェース設計、インフラ層分離、楽観ロック |
| ドメインサービス (DomainService) | 10% | ステートレス性、責務の明確さ、ドメイン例外 |
| ドメインイベント (DomainEvent) | 15% | イベント定義、発行機構、イベント駆動連携の基盤 |

```
Tactical = ValueObject × 0.20 + Entity × 0.20 + Aggregate × 0.20
         + Repository × 0.15 + DomainService × 0.10 + DomainEvent × 0.15
```

#### アーキテクチャスコア

| サブ項目 | 重み | 評価観点 |
|---------|------|---------|
| レイヤー分離 (LayerSeparation) | 40% | レイヤー境界の明確さ、循環依存の有無 |
| 依存関係の方向 (DependencyDirection) | 35% | 依存性逆転原則、外→内の一方向依存 |
| ポートとアダプター (PortsAndAdapters) | 25% | 入出力ポートの明示性、アダプター分離 |

```
Architecture = LayerSeparation × 0.40 + DependencyDirection × 0.35 + PortsAndAdapters × 0.25
```

#### 総合DDDスコア

```
DDD Score = Strategic × 0.30 + Tactical × 0.45 + Architecture × 0.25
```

### 2.3 サブ項目スコアリング基準 (0-100)

各サブ項目は以下の5段階ガイドラインに基づいて0-100で採点する。

| スコア帯 | 基準 |
|---------|------|
| **80-100** | パターンが正しく適用され、ベストプラクティスに合致。問題点が軽微 |
| **60-79** | パターンが概ね適用されているが、一部に改善余地あり |
| **40-59** | パターンが部分的に適用。明確な問題点が複数存在 |
| **20-39** | パターンの適用がごく一部。根本的な改善が必要 |
| **0-19** | パターンが未適用、または完全に欠如 |

**サブ項目別の採点指針（主要なもの）:**

- **値オブジェクト**: 値オブジェクト候補フィールド数に対する実装率、バリデーション有無、不変性確保
- **エンティティ**: ビジネスメソッド比率（目安: 40%以上でB, 60%以上でA）、setter排除、ファクトリ/復元メソッド
- **集約**: 内部状態の保護（防御的コピー）、集約間のID参照、不変条件の強制
- **ドメインイベント**: 主要ライフサイクルイベントの定義数（4種以上でB）、発行機構の実装

### 2.4 成熟度レベル

| スコア | グレード | レベル | マイクロサービス移行準備度 |
|--------|---------|--------|----------------------|
| 80-100 | A | Expert | DDD原則が十分に適用。移行準備完了 |
| 70-79 | B | Advanced | 良好なDDD実践。軽微な改善で移行可能 |
| 60-69 | C | Proficient | DDD部分適用。特定領域の強化が必要 |
| 50-59 | D | Beginner | DDD基礎は存在するが大きなギャップあり |
| 0-49 | E | Immature | DDD原則の適用が不十分。根本的な改善が必要 |

### 2.5 定性チェックリスト（補助）

スコアリングの裏付けとして以下のチェックリストを使用する。

#### 戦略的設計

- **境界コンテキスト**: ドメイン境界が明確に定義されているか
- **ユビキタス言語**: ドメイン用語がコードと一貫しているか
- **コンテキストマップ**: コンテキスト間の関係が定義されているか
- **コンテキスト関係パターン**: Shared Kernel / Customer-Supplier / ACL 等

#### 戦術的設計

- **エンティティ**: ID識別、ライフサイクル管理が適切か
- **値オブジェクト**: 不変性、バリデーション、ファクトリメソッド
- **集約**: 集約ルート、トランザクション境界が適切か
- **リポジトリ**: ドメイン層のインターフェース、インフラ層の実装分離
- **ドメインサービス**: エンティティに属さないビジネスロジックの配置
- **ドメインイベント**: ライフサイクルイベントの定義と発行機構

## 3. ドメイン分類マトリクス

### ビジネス構造軸

| タイプ | 特徴 | 例 |
|--------|------|-----|
| **Pipeline** | 順次的なデータ/プロセスフロー | 注文処理、ワークフロー |
| **Blackboard** | 共有データに対する協調作業 | 監査セット管理、在庫管理 |
| **Dialogue** | 双方向の対話・インタラクション | チャット、承認フロー |

### マイクロサービス境界軸

| タイプ | 特徴 | トランザクション | 例 |
|--------|------|-----------------|-----|
| **Process** | ビジネスプロセス実行 | Saga/2PC | 注文サービス |
| **Master** | マスターデータ管理 | CRUD中心 | 顧客サービス、商品サービス |
| **Integration** | 外部システム連携 | アダプター | Box連携、決済連携 |
| **Supporting** | 横断的関心事 | 軽量 | 認証、通知、ログ |
